<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.19">
    <title>è¡¨ç©ºé—´ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .header p a {
            color: white;
            text-decoration: underline;
            opacity: 0.9;
            transition: opacity 0.3s;
        }

        .header p a:hover {
            opacity: 1;
            text-decoration: none;
        }

        .controls {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
        }

        .stats {
            padding: 15px;
            background: white;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .stat-card {
            padding: 15px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .stat-card h3 {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 6px;
        }

        .stat-card .value {
            font-size: 22px;
            font-weight: 700;
            color: #2d3748;
        }

        .table-container {
            padding: 15px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background: #e9ecef;
        }

        th.sortable::after {
            content: 'â†•';
            position: absolute;
            right: 8px;
            opacity: 0.3;
        }

        th.sort-asc::after {
            content: 'â†‘';
            opacity: 1;
            color: #667eea;
        }

        th.sort-desc::after {
            content: 'â†“';
            opacity: 1;
            color: #667eea;
        }

        tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        td {
            padding: 12px 8px;
            font-size: 12px;
            color: #495057;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .filter-select {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .pagination {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .pagination-info {
            color: #6c757d;
            font-size: 12px;
        }

        .pagination-controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .pagination-btn {
            padding: 6px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            background: white;
            color: #495057;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: #667eea;
            color: #667eea;
            background: #f8f9fa;
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .page-size-select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }

        .time-shortcut-btn {
            padding: 4px 8px;
            border: 1px solid #667eea;
            border-radius: 4px;
            background: white;
            color: #667eea;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .time-shortcut-btn:hover {
            background: #667eea;
            color: white;
        }

        .time-shortcut-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                border-radius: 8px;
            }

            .header {
                padding: 10px 15px;
            }

            .header h1 {
                font-size: 18px;
                margin-bottom: 3px;
            }

            .header p {
                font-size: 11px;
            }

            .controls {
                padding: 10px;
                gap: 8px;
            }

            .search-box {
                width: 100%;
                min-width: 100%;
            }

            .filter-select {
                font-size: 12px;
                padding: 8px 12px;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                padding: 10px;
                gap: 8px;
            }

            .stat-card {
                padding: 10px;
            }

            .stat-card h3 {
                font-size: 11px;
                margin-bottom: 4px;
            }

            .stat-card .value {
                font-size: 18px;
            }

            .table-container {
                padding: 10px;
            }

            table {
                font-size: 10px;
            }

            th, td {
                padding: 8px 4px;
            }

            .pagination {
                padding: 10px;
                flex-direction: column;
                gap: 10px;
            }

            .pagination-controls {
                flex-wrap: wrap;
                justify-content: center;
                gap: 4px;
            }

            .pagination-btn {
                padding: 4px 8px;
                font-size: 11px;
            }

            .page-numbers {
                display: none;
            }

            .time-shortcut-btn {
                padding: 3px 6px;
                font-size: 10px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š è¡¨ç©ºé—´ç›‘æ§ç³»ç»Ÿ</h1>
            <p>ç›‘æ§æ•°æ®åº“è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ | <a href="trend.html">ğŸ“ˆ æŸ¥çœ‹è¶‹åŠ¿åˆ†æ</a></p>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœç´¢è¡¨ç©ºé—´åç§°ã€ä¸»æœºIP...">
                <span class="search-icon">ğŸ”</span>
            </div>
            <select id="hostFilter" class="filter-select">
                <option value="">æ‰€æœ‰ä¸»æœº</option>
            </select>
            <select id="statusFilter" class="filter-select">
                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                <option value="ONLINE">åœ¨çº¿</option>
                <option value="OFFLINE">ç¦»çº¿</option>
            </select>
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; flex: 1; min-width: 100%;">
                <label style="font-size: 13px; color: #6c757d; white-space: nowrap;">ğŸ“… æ—¥æœŸ:</label>
                <input type="date" id="startTime" class="filter-select" style="min-width: 150px; max-width: 150px;">
                <span style="color: #6c757d;">~</span>
                <input type="date" id="endTime" class="filter-select" style="min-width: 150px; max-width: 150px;">
                <button class="btn btn-secondary" onclick="clearTimeFilter()" style="padding: 6px 12px; font-size: 12px;">æ¸…é™¤</button>
                <span style="font-size: 12px; color: #6c757d; margin-left: 10px;">å¿«æ·:</span>
                <button class="time-shortcut-btn" onclick="setTimeRange(1)">1å¤©</button>
                <button class="time-shortcut-btn" onclick="setTimeRange(3)">3å¤©</button>
                <button class="time-shortcut-btn" onclick="setTimeRange(7)">7å¤©</button>
                <button class="time-shortcut-btn" onclick="setTimeRange(10)">10å¤©</button>
                <button class="time-shortcut-btn" onclick="setTimeRange(15)">15å¤©</button>
                <button class="time-shortcut-btn" onclick="setTimeRange(30)">30å¤©</button>
                <button class="time-shortcut-btn" onclick="setTimeRange(60)">60å¤©</button>
                <button class="time-shortcut-btn" onclick="setTimeRange(90)">90å¤©</button>
                <span style="margin-left: auto;"></span>
                <button class="btn btn-primary" onclick="loadData(true)" style="padding: 8px 16px; font-size: 13px;">ğŸ”„ åˆ·æ–°</button>
                <button class="btn btn-secondary" onclick="clearCache()" style="padding: 8px 16px; font-size: 13px;">ğŸ—‘ï¸ æ¸…ç¼“å­˜</button>
                <button class="btn btn-secondary" onclick="exportData()" style="padding: 8px 16px; font-size: 13px;">ğŸ“¥ å¯¼å‡º</button>
            </div>
        </div>

        <div class="stats" id="statsContainer">
            <div class="stat-card">
                <h3>æ€»è¡¨ç©ºé—´æ•°</h3>
                <div class="value" id="totalCount">-</div>
            </div>
            <div class="stat-card">
                <h3>åœ¨çº¿è¡¨ç©ºé—´</h3>
                <div class="value" id="onlineCount">-</div>
            </div>
            <div class="stat-card warning">
                <h3>å¹³å‡ä½¿ç”¨ç‡</h3>
                <div class="value" id="avgUsage">-</div>
            </div>
            <div class="stat-card">
                <h3>æ€»ç©ºé—´ (GB)</h3>
                <div class="value" id="totalSpace">-</div>
            </div>
        </div>

        <div class="table-container">
            <div id="loadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
            </div>
            <table id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th class="sortable" data-column="created_at">é‡‡é›†æ—¶é—´</th>
                        <th class="sortable" data-column="host_ip">ä¸»æœºIP</th>
                        <th class="sortable" data-column="tablespace_name">è¡¨ç©ºé—´åç§°</th>
                        <th class="sortable" data-column="status">çŠ¶æ€</th>
                        <th class="sortable" data-column="ts_type">ç±»å‹</th>
                        <th class="sortable" data-column="tablespace_size_mb">å¤§å°(MB)</th>
                        <th class="sortable" data-column="used_mb">å·²ç”¨(MB)</th>
                        <th class="sortable" data-column="free_mb">å¯ç”¨(MB)</th>
                        <th class="sortable" data-column="pct_used">ä½¿ç”¨ç‡</th>
                        <th class="sortable" data-column="pct_free">ç©ºé—²ç‡</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
            <div id="noDataIndicator" class="no-data" style="display: none;">
                <p>ğŸ“­ æš‚æ— æ•°æ®</p>
            </div>
        </div>

        <div class="pagination" id="paginationContainer" style="display: none;">
            <div class="pagination-info">
                æ˜¾ç¤ºç¬¬ <strong id="pageStart">1</strong> - <strong id="pageEnd">50</strong> æ¡ï¼Œ
                å…± <strong id="totalRecords">0</strong> æ¡è®°å½•
            </div>
            <div class="pagination-controls">
                <button class="pagination-btn" id="firstPageBtn" onclick="goToPage(1)">é¦–é¡µ</button>
                <button class="pagination-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)">ä¸Šä¸€é¡µ</button>
                
                <div class="page-numbers" id="pageNumbers"></div>
                
                <button class="pagination-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)">ä¸‹ä¸€é¡µ</button>
                <button class="pagination-btn" id="lastPageBtn" onclick="goToPage(totalPages)">æœ«é¡µ</button>
                
                <select class="page-size-select" id="pageSizeSelect" onchange="changePageSize()">
                    <option value="20">æ¯é¡µ 20 æ¡</option>
                    <option value="50" selected>æ¯é¡µ 50 æ¡</option>
                    <option value="100">æ¯é¡µ 100 æ¡</option>
                    <option value="200">æ¯é¡µ 200 æ¡</option>
                    <option value="500">æ¯é¡µ 500 æ¡</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        // ä¿®æ”¹APIé…ç½®ä¸ºæœ¬åœ°æ•°æ®æ–‡ä»¶
        const DATA_FILE_URL = './data/tablespace_data.json';
        
        // ç¼“å­˜é…ç½®
        const CACHE_KEY = 'tablespace_data_cache';
        const CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†é’Ÿç¼“å­˜
        
        let allData = [];
        let filteredData = [];
        let currentSort = { column: 'created_at', direction: 'desc' };  // é»˜è®¤æŒ‰æ—¶é—´å€’åº
        let currentPage = 1;
        let pageSize = 50;
        let totalPages = 1;

        // ä» URL è·å– host å‚æ•°
        function getHostFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('host') || '%'; // é»˜è®¤ % è¡¨ç¤ºæŸ¥è¯¢æ‰€æœ‰ä¸»æœº
        }

        // ç¼“å­˜ç®¡ç†å‡½æ•°
        function getCachedData() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (!cached) return null;
                
                const { data, timestamp } = JSON.parse(cached);
                const now = Date.now();
                
                // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
                if (now - timestamp > CACHE_DURATION) {
                    localStorage.removeItem(CACHE_KEY);
                    return null;
                }
                
                console.log('âœ… ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œç¼“å­˜æ—¶é—´:', new Date(timestamp).toLocaleString());
                return data;
            } catch (e) {
                console.error('è¯»å–ç¼“å­˜å¤±è´¥:', e);
                return null;
            }
        }
        
        function setCachedData(data) {
            try {
                const cacheObj = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheObj));
                console.log('ğŸ’¾ æ•°æ®å·²ç¼“å­˜');
            } catch (e) {
                console.error('ä¿å­˜ç¼“å­˜å¤±è´¥:', e);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        window.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            // è®¾ç½®è‡ªåŠ¨åˆ·æ–°ï¼ˆ5åˆ†é’Ÿåå°åˆ·æ–°ä¸€æ¬¡ï¼‰
            setInterval(() => {
                console.log('ğŸ”„ è‡ªåŠ¨åå°åˆ·æ–°æ•°æ®...');
                fetchDataFromFile(true);
            }, 5 * 60 * 1000);
        });

        // æœç´¢åŠŸèƒ½
        document.getElementById('searchInput').addEventListener('input', filterData);
        document.getElementById('hostFilter').addEventListener('change', filterData);
        document.getElementById('statusFilter').addEventListener('change', filterData);
        document.getElementById('startTime').addEventListener('change', filterData);
        document.getElementById('endTime').addEventListener('change', filterData);

        // æ’åºåŠŸèƒ½
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => sortTable(th.dataset.column));
            
            // è®¾ç½®é»˜è®¤æ’åºæ ‡è¯†ï¼ˆæ—¶é—´å€’åºï¼‰
            if (th.dataset.column === 'created_at') {
                th.classList.add('sort-desc');
            }
        });

        async function loadData(forceRefresh = false) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const dataTable = document.getElementById('dataTable');
            const noDataIndicator = document.getElementById('noDataIndicator');

            // å¦‚æœä¸æ˜¯å¼ºåˆ¶åˆ·æ–°ï¼Œå…ˆå°è¯•ä½¿ç”¨ç¼“å­˜
            if (!forceRefresh) {
                const cachedData = getCachedData();
                if (cachedData && cachedData.length > 0) {
                    console.log('âš¡ ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œç«‹å³æ˜¾ç¤º');
                    allData = cachedData;
                    
                    // æŒ‰ç…§æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                    allData.sort((a, b) => {
                        const timeA = new Date(a.created_at || 0);
                        const timeB = new Date(b.created_at || 0);
                        return timeB - timeA;
                    });
                    
                    filteredData = [...allData];
                    updateStats();
                    updateHostFilter();
                    renderTable();

                    loadingIndicator.style.display = 'none';
                    dataTable.style.display = 'table';
                    
                    // åå°å¼‚æ­¥åˆ·æ–°æ•°æ®
                    setTimeout(() => {
                        console.log('ğŸ”„ åå°åˆ·æ–°æ•°æ®...');
                        fetchDataFromFile(true);
                    }, 100);
                    
                    return;
                }
            }

            // æ²¡æœ‰ç¼“å­˜æˆ–å¼ºåˆ¶åˆ·æ–°ï¼Œæ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            loadingIndicator.style.display = 'block';
            dataTable.style.display = 'none';
            noDataIndicator.style.display = 'none';

            await fetchDataFromFile(false);
        }

        async function fetchDataFromFile(isBackgroundRefresh = false) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const dataTable = document.getElementById('dataTable');
            const noDataIndicator = document.getElementById('noDataIndicator');

            try {
                if (!isBackgroundRefresh) {
                    console.log('ğŸš€ å¼€å§‹åŠ è½½æœ¬åœ°æ•°æ®æ–‡ä»¶...');
                    console.log('ğŸ“ æ•°æ®æ–‡ä»¶ URL:', DATA_FILE_URL);
                }
                
                const response = await fetch(DATA_FILE_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                // ä»æœ¬åœ°JSONæ–‡ä»¶ä¸­æå–æ•°æ®
                allData = result.data || [];
                
                // ä¿å­˜åˆ°ç¼“å­˜
                setCachedData(allData);
                
                if (!isBackgroundRefresh) {
                    console.log('âœ… æˆåŠŸåŠ è½½æ•°æ®:', allData.length, 'æ¡è®°å½•');
                    console.log('ğŸ•’ æ•°æ®æ›´æ–°æ—¶é—´:', result.last_update);
                }
                
                // æŒ‰ç…§æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                allData.sort((a, b) => {
                    const timeA = new Date(a.created_at || 0);
                    const timeB = new Date(b.created_at || 0);
                    return timeB - timeA;
                });
                
                filteredData = [...allData];

                updateStats();
                updateHostFilter();
                renderTable();

                if (!isBackgroundRefresh) {
                    loadingIndicator.style.display = 'none';
                    if (allData.length > 0) {
                        dataTable.style.display = 'table';
                    } else {
                        noDataIndicator.style.display = 'block';
                    }
                }
            } catch (error) {
                if (!isBackgroundRefresh) {
                    console.error('âŒ æ•°æ®åŠ è½½å¤±è´¥:', error);
                    loadingIndicator.style.display = 'none';
                    
                    // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
                    noDataIndicator.innerHTML = `
                    <div style="max-width: 600px; margin: 0 auto; text-align: left;">
                        <h2 style="color: #dc3545; margin-bottom: 20px;">âŒ æ•°æ®åŠ è½½å¤±è´¥</h2>
                        <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <strong>é”™è¯¯ä¿¡æ¯ï¼š</strong><br>
                            <code style="color: #721c24;">${error.message}</code>
                        </div>
                        <div style="background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <strong>ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®</li>
                                <li>æœ¬åœ°æœåŠ¡å™¨æœªè¿è¡Œ</li>
                                <li>æµè§ˆå™¨è·¨åŸŸé™åˆ¶</li>
                            </ul>
                        </div>
                        <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px;">
                            <strong>ğŸ”§ è§£å†³æ–¹æ¡ˆï¼š</strong>
                            <ol style="margin: 10px 0; padding-left: 20px;">
                                <li>ç¡®ä¿å·²è¿è¡Œæ•°æ®é‡‡é›†è„šæœ¬</li>
                                <li>ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œï¼š
                                    <pre style="background: #2d3748; color: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 5px; overflow-x: auto;">python3 -m http.server 8000</pre>
                                </li>
                                <li>æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å° (F12) æŸ¥çœ‹è¯¦ç»†é”™è¯¯</li>
                            </ol>
                        </div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button class="btn btn-primary" onclick="loadData(true)" style="margin-top: 10px;">ğŸ”„ é‡è¯•</button>
                        </div>
                    </div>
                    `;
                    noDataIndicator.style.display = 'block';
                } else {
                    console.warn('âš ï¸ åå°åˆ·æ–°å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨ç¼“å­˜æ•°æ®');
                }
            }
        }

        function parseApiResponse(result) {
            console.log('API åŸå§‹å“åº”:', result);
            
            // å¤„ç†ä¸åŒçš„å“åº”æ ¼å¼
            if (Array.isArray(result)) {
                return result;
            } else if (result.data && Array.isArray(result.data.rows)) {
                return result.data.rows;
            } else if (result.data && Array.isArray(result.data)) {
                return result.data;
            } else if (result.rows && Array.isArray(result.rows)) {
                return result.rows;
            } else {
                console.warn('æœªçŸ¥çš„æ•°æ®æ ¼å¼ï¼Œå°è¯•è§£æ:', result);
                return [];
            }
        }

        function updateStats() {
            const total = allData.length;
            const online = allData.filter(item => item.status === 'ONLINE').length;
            const totalSpaceMB = allData.reduce((sum, item) => sum + parseFloat(item.tablespace_size_mb || 0), 0);
            const avgUsage = total > 0 
                ? (allData.reduce((sum, item) => sum + parseFloat(item.pct_used || 0), 0) / total).toFixed(1)
                : 0;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('onlineCount').textContent = online;
            document.getElementById('avgUsage').textContent = avgUsage + '%';
            document.getElementById('totalSpace').textContent = (totalSpaceMB / 1024).toFixed(2);
        }

        function updateHostFilter() {
            const hosts = [...new Set(allData.map(item => item.host_ip))];
            const hostFilter = document.getElementById('hostFilter');
            const currentValue = hostFilter.value;

            hostFilter.innerHTML = '<option value="">æ‰€æœ‰ä¸»æœº</option>';
            hosts.forEach(host => {
                const option = document.createElement('option');
                option.value = host;
                option.textContent = host;
                hostFilter.appendChild(option);
            });

            hostFilter.value = currentValue;
        }

        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const hostFilter = document.getElementById('hostFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;

            filteredData = allData.filter(item => {
                const matchesSearch = !searchTerm || 
                    (item.tablespace_name && item.tablespace_name.toLowerCase().includes(searchTerm)) ||
                    (item.host_ip && item.host_ip.toLowerCase().includes(searchTerm));
                
                const matchesHost = !hostFilter || item.host_ip === hostFilter;
                const matchesStatus = !statusFilter || item.status === statusFilter;
                
                // æ—¥æœŸèŒƒå›´ç­›é€‰ï¼ˆåªæ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†ï¼Œä¸å«æ—¶é—´ï¼‰
                let matchesTime = true;
                if (item.created_at) {
                    const itemDate = new Date(item.created_at);
                    // åªå–æ—¥æœŸéƒ¨åˆ†ï¼Œå¿½ç•¥æ—¶é—´
                    const itemDateOnly = new Date(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate());
                    
                    if (startTime) {
                        const start = new Date(startTime);
                        const startDateOnly = new Date(start.getFullYear(), start.getMonth(), start.getDate());
                        matchesTime = matchesTime && itemDateOnly >= startDateOnly;
                    }
                    if (endTime) {
                        const end = new Date(endTime);
                        // ç»“æŸæ—¥æœŸåŒ…å«å½“å¤©çš„23:59:59
                        const endDateOnly = new Date(end.getFullYear(), end.getMonth(), end.getDate(), 23, 59, 59);
                        matchesTime = matchesTime && itemDate <= endDateOnly;
                    }
                }

                return matchesSearch && matchesHost && matchesStatus && matchesTime;
            });

            // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            currentPage = 1;
            renderTable();
        }
        
        function clearTimeFilter() {
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            // ç§»é™¤æ‰€æœ‰å¿«æ·æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.time-shortcut-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            filterData();
        }
        
        function setTimeRange(days) {
            const now = new Date();
            const start = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
            
            // æ ¼å¼åŒ–ä¸ºæ—¥æœŸæ ¼å¼ (YYYY-MM-DD)
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            document.getElementById('startTime').value = formatDate(start);
            document.getElementById('endTime').value = formatDate(now);
            
            // æ›´æ–°å¿«æ·æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.time-shortcut-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            filterData();
        }

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // æ›´æ–°è¡¨å¤´æ ·å¼
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.column === column) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });

            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const paginationContainer = document.getElementById('paginationContainer');

            // æ’åºæ•°æ®
            let sortedData = [...filteredData];
            if (currentSort.column) {
                sortedData.sort((a, b) => {
                    let aVal = a[currentSort.column];
                    let bVal = b[currentSort.column];

                    // æ—¶é—´ç±»å‹æ’åº
                    if (currentSort.column === 'created_at') {
                        aVal = new Date(aVal || 0);
                        bVal = new Date(bVal || 0);
                    }
                    // æ•°å­—ç±»å‹æ’åº
                    else if (['tablespace_size_mb', 'used_mb', 'free_mb', 'pct_used', 'pct_free', 'max_mb'].includes(currentSort.column)) {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                    }

                    if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // è®¡ç®—åˆ†é¡µ
            totalPages = Math.ceil(sortedData.length / pageSize);
            if (currentPage > totalPages) currentPage = totalPages || 1;

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, sortedData.length);
            const pageData = sortedData.slice(startIndex, endIndex);

            // æ¸²æŸ“è¡¨æ ¼
            tbody.innerHTML = '';
            pageData.forEach(item => {
                const row = document.createElement('tr');
                const pctUsed = parseFloat(item.pct_used) || 0;
                const createdAt = item.created_at ? formatDateTime(item.created_at) : '-';

                row.innerHTML = `
                    <td style="font-size: 12px; color: #6c757d;">${createdAt}</td>
                    <td>${item.host_ip || '-'}</td>
                    <td><strong>${item.tablespace_name || '-'}</strong></td>
                    <td><span class="status-badge ${item.status === 'ONLINE' ? 'status-online' : 'status-offline'}">${item.status || '-'}</span></td>
                    <td>${item.ts_type || '-'}</td>
                    <td>${formatNumber(item.tablespace_size_mb)}</td>
                    <td>${formatNumber(item.used_mb)}</td>
                    <td>${formatNumber(item.free_mb)}</td>
                    <td>
                        <div>${pctUsed.toFixed(2)}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill ${pctUsed > 80 ? 'warning' : ''}" style="width: ${pctUsed}%"></div>
                        </div>
                    </td>
                    <td>${parseFloat(item.pct_free).toFixed(2)}%</td>
                `;
                tbody.appendChild(row);
            });

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            updatePagination(sortedData.length, startIndex, endIndex);

            // æ˜¾ç¤º/éšè—åˆ†é¡µæ§ä»¶
            if (sortedData.length > pageSize) {
                paginationContainer.style.display = 'flex';
            } else {
                paginationContainer.style.display = sortedData.length > 0 ? 'flex' : 'none';
            }
        }

        function updatePagination(total, start, end) {
            document.getElementById('totalRecords').textContent = total;
            document.getElementById('pageStart').textContent = total > 0 ? start + 1 : 0;
            document.getElementById('pageEnd').textContent = end;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('firstPageBtn').disabled = currentPage === 1;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages;

            // æ¸²æŸ“é¡µç 
            renderPageNumbers();
        }

        function renderPageNumbers() {
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';

            if (totalPages <= 1) return;

            // è®¡ç®—è¦æ˜¾ç¤ºçš„é¡µç èŒƒå›´
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            // å¦‚æœé¡µæ•°è¾ƒå°‘ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡µç 
            if (totalPages <= 7) {
                startPage = 1;
                endPage = totalPages;
            }

            // æ·»åŠ é¡µç æŒ‰é’®
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = 'pagination-btn' + (i === currentPage ? ' active' : '');
                btn.textContent = i;
                btn.onclick = () => goToPage(i);
                pageNumbers.appendChild(btn);
            }
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1;
            renderTable();
        }

        function formatNumber(num) {
            const n = parseFloat(num);
            return isNaN(n) ? '-' : n.toLocaleString('zh-CN', { maximumFractionDigits: 2 });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        function exportData() {
            if (filteredData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            // ç”Ÿæˆ CSV
            const headers = ['é‡‡é›†æ—¶é—´', 'ä¸»æœºIP', 'è¡¨ç©ºé—´åç§°', 'çŠ¶æ€', 'ç±»å‹', 'å¤§å°(MB)', 'å·²ç”¨(MB)', 'å¯ç”¨(MB)', 'ä½¿ç”¨ç‡', 'ç©ºé—²ç‡'];
            const csvContent = [
                headers.join(','),
                ...filteredData.map(item => [
                    item.created_at || '',
                    item.host_ip,
                    item.tablespace_name,
                    item.status,
                    item.ts_type,
                    item.tablespace_size_mb,
                    item.used_mb,
                    item.free_mb,
                    item.pct_used,
                    item.pct_free
                ].join(','))
            ].join('\n');

            // ä¸‹è½½æ–‡ä»¶
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è¡¨ç©ºé—´æ•°æ®_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function clearCache() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ç¼“å­˜å—ï¼Ÿæ¸…é™¤åä¸‹æ¬¡è®¿é—®å°†é‡æ–°åŠ è½½æ•°æ®ã€‚')) {
                try {
                    localStorage.removeItem(CACHE_KEY);
                    console.log('âœ… ç¼“å­˜å·²æ¸…é™¤');
                    alert('ç¼“å­˜å·²æ¸…é™¤æˆåŠŸï¼');
                    
                    // æ¸…é™¤ç¼“å­˜åé‡æ–°åŠ è½½æ•°æ®
                    loadData(true);
                } catch (e) {
                    console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', e);
                    alert('æ¸…é™¤ç¼“å­˜å¤±è´¥ï¼š' + e.message);
                }
            }
        }
    </script>
</body>
</html>
